{"componentChunkName":"component---src-templates-post-js","path":"/weakmap-weakset/","webpackCompilationHash":"196e346d32b2958b0f26","result":{"data":{"markdownRemark":{"html":"<h1 id=\"weakmap-and-weakset\"><a href=\"#weakmap-and-weakset\" aria-label=\"weakmap and weakset permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WeakMap and WeakSet</h1>\n<p>As we know from the chapter &#x3C;info:garbage-collection>, JavaScript engine stores a value in memory while it is reachable (and can potentially be used).</p>\n<p>For instance:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> john <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"John\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// the object can be accessed, john is the reference to it</span>\n\n<span class=\"token comment\">// overwrite the reference</span>\njohn <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\">// the object will be removed from memory</span></code></pre></div>\n<p>Usually, properties of an object or elements of an array or another data structure are considered reachable and kept in memory while that data structure is in memory.</p>\n<p>For instance, if we put an object into an array, then while the array is alive, the object will be alive as well, even if there are no other references to it.</p>\n<p>Like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> john <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"John\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> array <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span> john <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\njohn <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// overwrite the reference</span>\n\n\n<span class=\"token comment\">// john is stored inside the array, so it won't be garbage-collected</span>\n<span class=\"token comment\">// we can get it as array[0]</span></code></pre></div>\n<p>Similar to that, if we use an object as the key in a regular <code class=\"language-text\">Map</code>, then while the <code class=\"language-text\">Map</code> exists, that object exists as well. It occupies memory and may not be garbage collected.</p>\n<p>For instance:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> john <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"John\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> map <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nmap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>john<span class=\"token punctuation\">,</span> <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\njohn <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// overwrite the reference</span>\n\n\n<span class=\"token comment\">// john is stored inside the map,</span>\n<span class=\"token comment\">// we can get it by using map.keys()</span></code></pre></div>\n<p><code class=\"language-text\">WeakMap</code> is fundamentally different in this aspect. It doesn't prevent garbage-collection of key objects.</p>\n<p>Let's see what it means on examples.</p>\n<h2 id=\"weakmap\"><a href=\"#weakmap\" aria-label=\"weakmap permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WeakMap</h2>\n<p>The first difference from <code class=\"language-text\">Map</code> is that <code class=\"language-text\">WeakMap</code> keys must be objects, not primitive values:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> weakMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nweakMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ok\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// works fine (object key)</span>\n\n\n<span class=\"token comment\">// can't use a string as the key</span>\nweakMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Whoops\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Error, because \"test\" is not an object</span></code></pre></div>\n<p>Now, if we use an object as the key in it, and there are no other references to that object -- it will be removed from memory (and from the map) automatically.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> john <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"John\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> weakMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nweakMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>john<span class=\"token punctuation\">,</span> <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\njohn <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// overwrite the reference</span>\n\n<span class=\"token comment\">// john is removed from memory!</span></code></pre></div>\n<p>Compare it with the regular <code class=\"language-text\">Map</code> example above. Now if <code class=\"language-text\">john</code> only exists as the key of <code class=\"language-text\">WeakMap</code> -- it will be automatically deleted from the map (and memory).</p>\n<p><code class=\"language-text\">WeakMap</code> does not support iteration and methods <code class=\"language-text\">keys()</code>, <code class=\"language-text\">values()</code>, <code class=\"language-text\">entries()</code>, so there's no way to get all keys or values from it.</p>\n<p><code class=\"language-text\">WeakMap</code> has only the following methods:</p>\n<ul>\n<li><code class=\"language-text\">weakMap.get(key)</code></li>\n<li><code class=\"language-text\">weakMap.set(key, value)</code></li>\n<li><code class=\"language-text\">weakMap.delete(key)</code></li>\n<li><code class=\"language-text\">weakMap.has(key)</code></li>\n</ul>\n<p>Why such a limitation? That's for technical reasons. If an object has lost all other references (like <code class=\"language-text\">john</code> in the code above), then it is to be garbage-collected automatically. But technically it's not exactly specified <em>when the cleanup happens</em>.</p>\n<p>The JavaScript engine decides that. It may choose to perform the memory cleanup immediately or to wait and do the cleaning later when more deletions happen. So, technically the current element count of a <code class=\"language-text\">WeakMap</code> is not known. The engine may have cleaned it up or not, or did it partially. For that reason, methods that access all keys/values are not supported.</p>\n<p>Now where do we need such data structure?</p>\n<h2 id=\"use-case-additional-data\"><a href=\"#use-case-additional-data\" aria-label=\"use case additional data permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use case: additional data</h2>\n<p>The main area of application for <code class=\"language-text\">WeakMap</code> is an <em>additional data storage</em>.</p>\n<p>If we're working with an object that \"belongs\" to another code, maybe even a third-party library, and would like to store some data associated with it, that should only exist while the object is alive - then <code class=\"language-text\">WeakMap</code> is exactly what's needed.</p>\n<p>We put the data to a <code class=\"language-text\">WeakMap</code>, using the object as the key, and when the object is garbage collected, that data will automatically disappear as well.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">weakMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>john<span class=\"token punctuation\">,</span> <span class=\"token string\">\"secret documents\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// if john dies, secret documents will be destroyed automatically</span></code></pre></div>\n<p>Let's look at an example.</p>\n<p>For instance, we have code that keeps a visit count for users. The information is stored in a map: a user object is the key and the visit count is the value. When a user leaves (its object gets garbage collected), we don't want to store their visit count anymore.</p>\n<p>Here's an example of a counting function with <code class=\"language-text\">Map</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// üìÅ visitsCount.js</span>\n<span class=\"token keyword\">let</span> visitsCountMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// map: user => visits count</span>\n\n<span class=\"token comment\">// increase the visits count</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">countUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> count <span class=\"token operator\">=</span> visitsCountMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  visitsCountMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And here's another part of the code, maybe another file using it:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// üìÅ main.js</span>\n<span class=\"token keyword\">let</span> john <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"John\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">countUser</span><span class=\"token punctuation\">(</span>john<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// count his visits</span>\n\n<span class=\"token comment\">// later john leaves us</span>\njohn <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now <code class=\"language-text\">john</code> object should be garbage collected, but remains in memory, as it's a key in <code class=\"language-text\">visitsCountMap</code>.</p>\n<p>We need to clean <code class=\"language-text\">visitsCountMap</code> when we remove users, otherwise it will grow in memory indefinitely. Such cleaning can become a tedious task in complex architectures.</p>\n<p>We can avoid it by switching to <code class=\"language-text\">WeakMap</code> instead:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// üìÅ visitsCount.js</span>\n<span class=\"token keyword\">let</span> visitsCountMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// weakmap: user => visits count</span>\n\n<span class=\"token comment\">// increase the visits count</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">countUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> count <span class=\"token operator\">=</span> visitsCountMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  visitsCountMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we don't have to clean <code class=\"language-text\">visitsCountMap</code>. After <code class=\"language-text\">john</code> object becomes unreachable by all means except as a key of <code class=\"language-text\">WeakMap</code>, it gets removed from memory, along with the information by that key from <code class=\"language-text\">WeakMap</code>.</p>\n<h2 id=\"use-case-caching\"><a href=\"#use-case-caching\" aria-label=\"use case caching permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use case: caching</h2>\n<p>Another common example is caching: when a function result should be remembered (\"cached\"), so that future calls on the same object reuse it.</p>\n<p>We can use <code class=\"language-text\">Map</code> to store results, like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// üìÅ cache.js</span>\n<span class=\"token keyword\">let</span> cache <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// calculate and remember the result</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token comment\">/* calculations of the result for */</span> obj<span class=\"token punctuation\">;</span>\n\n    cache<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\">// Now we use process() in another file:</span>\n\n\n<span class=\"token comment\">// üìÅ main.js</span>\n<span class=\"token keyword\">let</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* let's say we have an object */</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> result1 <span class=\"token operator\">=</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// calculated</span>\n\n<span class=\"token comment\">// ...later, from another place of the code...</span>\n<span class=\"token keyword\">let</span> result2 <span class=\"token operator\">=</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// remembered result taken from cache</span>\n\n<span class=\"token comment\">// ...later, when the object is not needed any more:</span>\nobj <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1 (Ouch! The object is still in cache, taking memory!)</span></code></pre></div>\n<p>For multiple calls of <code class=\"language-text\">process(obj)</code> with the same object, it only calculates the result the first time, and then just takes it from <code class=\"language-text\">cache</code>. The downside is that we need to clean <code class=\"language-text\">cache</code> when the object is not needed any more.</p>\n<p>If we replace <code class=\"language-text\">Map</code> with <code class=\"language-text\">WeakMap</code>, then this problem disappears: the cached result will be removed from memory automatically after the object gets garbage collected.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// üìÅ cache.js</span>\n\n<span class=\"token keyword\">let</span> cache <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\">// calculate and remember the result</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token comment\">/* calculate the result for */</span> obj<span class=\"token punctuation\">;</span>\n\n    cache<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// üìÅ main.js</span>\n<span class=\"token keyword\">let</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* some object */</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> result1 <span class=\"token operator\">=</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> result2 <span class=\"token operator\">=</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ...later, when the object is not needed any more:</span>\nobj <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Can't get cache.size, as it's a WeakMap,</span>\n<span class=\"token comment\">// but it's 0 or soon be 0</span>\n<span class=\"token comment\">// When obj gets garbage collected, cached data will be removed as well</span></code></pre></div>\n<h2 id=\"weakset\"><a href=\"#weakset\" aria-label=\"weakset permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WeakSet</h2>\n<p><code class=\"language-text\">WeakSet</code> behaves similarly:</p>\n<ul>\n<li>It is analogous to <code class=\"language-text\">Set</code>, but we may only add objects to <code class=\"language-text\">WeakSet</code> (not primitives).</li>\n<li>An object exists in the set while it is reachable from somewhere else.</li>\n<li>Like <code class=\"language-text\">Set</code>, it supports <code class=\"language-text\">add</code>, <code class=\"language-text\">has</code> and <code class=\"language-text\">delete</code>, but not <code class=\"language-text\">size</code>, <code class=\"language-text\">keys()</code> and no iterations.</li>\n</ul>\n<p>Being \"weak\", it also serves as an additional storage. But not for an arbitrary data, but rather for \"yes/no\" facts. A membership in <code class=\"language-text\">WeakSet</code> may mean something about the object.</p>\n<p>For instance, we can add users to <code class=\"language-text\">WeakSet</code> to keep track of those who visited our site:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> visitedSet <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> john <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"John\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> pete <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Pete\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> mary <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Mary\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nvisitedSet<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>john<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// John visited us</span>\nvisitedSet<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>pete<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Then Pete</span>\nvisitedSet<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>john<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// John again</span>\n\n<span class=\"token comment\">// visitedSet has 2 users now</span>\n\n<span class=\"token comment\">// check if John visited?</span>\n<span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>visitedSet<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>john<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span>\n\n<span class=\"token comment\">// check if Mary visited?</span>\n<span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>visitedSet<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>mary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// false</span>\n\njohn <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// visitedSet will be cleaned automatically</span></code></pre></div>\n<p>The most notable limitation of <code class=\"language-text\">WeakMap</code> and <code class=\"language-text\">WeakSet</code> is the absence of iterations, and inability to get all current content. That may appear inconvenient, but does not prevent <code class=\"language-text\">WeakMap/WeakSet</code> from doing their main job -- be an \"additional\" storage of data for objects which are stored/managed at another place.</p>\n<h2 id=\"summary\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p><code class=\"language-text\">WeakMap</code> is <code class=\"language-text\">Map</code>-like collection that allows only objects as keys and removes them together with associated value once they become inaccessible by other means.</p>\n<p><code class=\"language-text\">WeakSet</code> is <code class=\"language-text\">Set</code>-like collection that stores only objects and removes them once they become inaccessible by other means.</p>\n<p>Both of them do not support methods and properties that refer to all keys or their count. Only individual operations are allowed.</p>\n<p><code class=\"language-text\">WeakMap</code> and <code class=\"language-text\">WeakSet</code> are used as \"secondary\" data structures in addition to the \"main\" object storage. Once the object is removed from the main storage, if it is only found as the key of <code class=\"language-text\">WeakMap</code> or in a <code class=\"language-text\">WeakSet</code>, it will be cleaned up automatically.</p>","timeToRead":7,"excerpt":"WeakMap and WeakSet As we know from the chapter <info:garbage-collection>, JavaScript engine stores a value in memory while it is reachable‚Ä¶","frontmatter":{"title":"[javascript.info] - Data Types: WeakMap and WeakSet","thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+0lEQVQ4y2P4eCeYbMTw4bYf2Qio2Z9sNAw1vwcjBPcWCJFj87ubwOD1/3QXpP/dTWJshlkFtP/X48B3t/xfXvX78Sjw24MAiDgDVj2f7/k/veibEm9RmG318Y7/l/sBi6c5BfqZurkal+RZXTvi/eUeSD92zUDVD8/6GhkbODkZ/3kauG2Fm7KarqOjUVSYmaSsTn257U+gQ27i0nwv4NE5XxtrQy9Pk/8vg9rr7KTldbascP3/IXjXardH532BnsfpbKDmh+d8La0MPd1N/j0PXDrDWU5JNyTIbMsy128PA349CYSEGQO2gEVo9vY0AbJfX/cDel5BRVdBWdff13T/BvfvDwOwOBsYpEAnfbob8OCMr5WVoY+XCSTAfjwG+tw1LdFCTUPP3Nzw6mFvYJgzoDn4x6OAx+d9gQ57dc3P0hJkM1ARMOQvHfD6/zb4/7vgtlqQ/5fNcv7zLJAB2bVAnctnO1taGi2a5rRkhrOKml5ijAXQIcBABob84hnOR7Z4JMWayyrobl3u9vsJqmagT3atcbOwMARKyynpGJsY7FjpBowqYIBZWBrKKgIFdRVVdAsyrd7e8AN6B93ZPx8H3Dnls2qeC9Bhlw56QRIT0BdAwfULXRbPcAKGFlDlZ6yJBGj/1/sBv58GAhEwViDJEFkQaBDEGiAJAFoY9rjTFvN3AAAAAElFTkSuQmCC","width":150,"height":150,"src":"/static/0cded3a3276425911d55a2552bf361bf/4148e/javascript.png","srcSet":"/static/0cded3a3276425911d55a2552bf361bf/4148e/javascript.png 1x,\n/static/0cded3a3276425911d55a2552bf361bf/de03e/javascript.png 1.5x,\n/static/0cded3a3276425911d55a2552bf361bf/1e9e2/javascript.png 2x"}}},"slug":"weakmap-weakset","date":"2020-03-28T00:00:00.000Z","categories":["Code"],"tags":["javascript.info","data-types"],"template":"post"},"fields":{"slug":"/weakmap-weakset/","date":"2020-03-28T00:00:00.000Z"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/weakmap-weakset/"}}}